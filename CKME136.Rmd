---
title: "CKME136 Capstone Project"
author: "Brendan Behan"
date: '2020-03-23'
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# # Set up R and Import 3 files (Opioids, Prescribers, Overdoses)

```{r}
install.packages("class", repos="http://cran.us.r-project.org")
install.packages("gmodels", repos="http://cran.us.r-project.org")
install.packages("biganalytics", repos="http://cran.us.r-project.org")
library(class)
library(gmodels)
library(ggplot2)
library(biganalytics)
library(dplyr)

opioids <- read.csv("C:/Users/bbehan/Desktop/ckme136/data/opioids.csv")
prescribers <- read.csv("C:/Users/bbehan/Desktop/ckme136/data/prescriber-info.csv")
overdoses <- read.csv("C:/Users/bbehan/Desktop/ckme136/data/overdoses.csv")

# check that files are loaded as data frames in R
df <- data.frame()
is.data.frame(opioids)
is.data.frame(prescribers)
is.data.frame(overdoses)

# check for missing values

sum(is.na(opioids))
sum(is.na(prescribers))
sum(is.na(overdoses))

```

# Explore datasets
# Opioids
# Prescribers
# Overdoses

```{r}
# Look at characteristics of Opioids file
summary(opioids)
head(opioids)
tail(opioids)

#There are 113 entries - with 5 instances of repetitions
```
```{r}
# Look at characteristics of Prescribers file
summary(prescribers)
head(prescribers)
tail(prescribers)

#There are 25,000 entries - with 256 columns per entry
```
```{r}
# Look at characteristics of Overdoses file
summary(overdoses)
head(overdoses)
tail(overdoses)

#There are 50 rows (one per US state) showing overall state population and # of deaths
```
#Step 1: Explore trends in opioid prescriptions
#The Opioids dataset will be used to pull out opioid prescriptions from the Prescribers dataset.

```{r}

## I want to take the drug names(first column) from the Opioids fileand cross-reference it with all the drug names (header) in the Prescribers file 

##Take out header information from Prescribers file and compare it to Opioids file

names(prescribers)
prescribers_column_names <- data.frame(names(prescribers))
is.data.frame(prescribers_column_names)

## View files to get column names

View(prescribers_column_names)
View(opioids)

##Compare drugs listed from Prescribers file with Opioids file

## Merge Function

identified_opioids <- merge(x=prescribers_column_names, y=opioids, by.x='names.prescribers.', by.y='Drug.Name')

View(identified_opioids)

#2 opioids identified - Fentanyl and Oxycontin. However, from visually inspecting datasets there should be more overlap, need to go back and clean datasets further (e.g., naming conventions)

# Clean up Opioid Dataset to replace spaces and hyphens with periods

opioids_drug.name <- opioids$Drug.Name

opioids_replace_space <- gsub(" ", ".", opioids_drug.name)

opioids_replace_space_and_hyphen <- gsub("-", ".", opioids_replace_space)

View(opioids_replace_space_and_hyphen)

# change name to show that opioids dataset have now been cleaned

opioids_cleaned <- opioids_replace_space_and_hyphen

# Re-run previous merge command

opioids_cleaned_df <- data.frame(opioids_cleaned)

identified_opioids_cleaned <- merge(x=prescribers_column_names, y=opioids_cleaned_df, by.x='names.prescribers.', by.y='opioids_cleaned')

View(identified_opioids_cleaned)

# 13 opioids identified - however 2 drugs are repeated - HYDROMORPHONE.HCL and MORPHINE.SULFATE

# Therefore, 11 of the 250 medications in the Prescribers file are opioids


# Determine how many prescribers have prescribed at least one of these opioids

prescriber_numbers <- nrow(prescribers)

print(prescriber_numbers)

# 25000 prescribers identified

# Identify which prescribers have prescribed at least one of the 11 listed opioids

prescriber_opioids <- filter(prescribers, (prescribers$ACETAMINOPHEN.CODEINE >= 1) | (prescribers$FENTANYL >= 1) | (prescribers$HYDROCODONE.ACETAMINOPHEN >= 1) | (prescribers$HYDROMORPHONE.HCL >= 1) | (prescribers$METHADONE.HCL >= 1) | (prescribers$MORPHINE.SULFATE >= 1) | (prescribers$MORPHINE.SULFATE.ER >= 1) | (prescribers$OXYCODONE.ACETAMINOPHEN >= 1) | (prescribers$OXYCODONE.HCL >= 1) | (prescribers$OXYCONTIN >= 1) | (prescribers$TRAMADOL.HCL >= 1))

nrow(prescriber_opioids)

# 12800 of listed 25000 prescribers have prescribed at least one of the 11 opioids

# Get %

percentage_prescribers_opioids <- nrow(prescriber_opioids) / prescriber_numbers * 100

print(percentage_prescribers_opioids)

# 51.2 % of prescribers have prescribed at least one opioid

# Breakdown per opioid

# 01. Acetaminophen.Codeine

prescribers_acetaminophen.codeine <- prescribers$ACETAMINOPHEN.CODEINE >= 1

summary(prescribers_acetaminophen.codeine)

# 2133 prescribers have prescribed Acetaminophen.Codeine at least once

percent_prescribers_acetaminophen.codeine <- (2133/prescriber_numbers)*100

print(percent_prescribers_acetaminophen.codeine)

# 2133 prescribers have prescribed Acetaminophen.Codeine - 8.532% of Prescribers

# 02. Fentanyl

prescribers_fentanyl <- prescribers$FENTANYL >= 1
summary(prescribers_fentanyl)

# 1965 prescribers have prescribed Fentanyl at least once

percent_prescribers_fentanyl <- (1965/prescriber_numbers)*100

print(percent_prescribers_fentanyl)

# 1965 prescribers have prescribed Fentanyl - 7.86% of Prescribers

# 03. Hydrocodone.Acetaminophen

prescribers_hydrocodone.acetaminophen <- prescribers$HYDROCODONE.ACETAMINOPHEN >= 1
summary(prescribers_hydrocodone.acetaminophen)

# 10044 prescribers have prescribed Hydrocodone.Acetaminophen at least once

percent_prescribers_hydrocodone.acetaminophen <- (10044/prescriber_numbers)*100

print(percent_prescribers_hydrocodone.acetaminophen)

# 10044 prescribers have prescribed Hydrocodone.Acetaminophen - 40.176% of Prescribers

# 04. Hydromorphone.HCL

prescribers_hydromorphone.HCL <- prescribers$HYDROMORPHONE.HCL >= 1

summary(prescribers_hydromorphone.HCL)

# 722 prescribers have prescribed Hydromorphone.HCL at least once

percent_prescribers_hydromorphone.HCL <- (722/prescriber_numbers)*100

print(percent_prescribers_hydromorphone.HCL)

# 722 prescribers have prescribed Hydromorphone.HCL - 2.888% of Prescribers

# 05. Methadone.HCL

prescribers_methadone.HCL <- prescribers$METHADONE.HCL >= 1

summary(prescribers_methadone.HCL)

# 865 prescribers have prescribed Methadone.HCL at least once

percent_prescribers_methadone.HCL <- (865/prescriber_numbers)*100

print(percent_prescribers_methadone.HCL)

# 865 prescribers have prescribed Methadone.HCL - 3.46% of Prescribers

# 06. Morphine.Sulfate

prescribers_morphine.sulfate <- prescribers$MORPHINE.SULFATE >= 1

summary(prescribers_morphine.sulfate)

# 674 prescribers have prescribed Morphine.Sulfate at least once

percent_prescribers_morphine.sulfate <- (674/prescriber_numbers)*100

print(percent_prescribers_morphine.sulfate)

# 674 prescribers have prescribed Morphine.Sulfate - 2.696% of Prescribers


# 07. Morphine.Sulfate.ER

prescribers_morphine.sulfate.er <- prescribers$MORPHINE.SULFATE.ER >= 1

summary(prescribers_morphine.sulfate.er)

# 1738 prescribers have prescribed Morphine.Sulfate.Er at least once

percent_prescribers_morphine.sulfate.er <- (1738/prescriber_numbers)*100

print(percent_prescribers_morphine.sulfate.er)

# 1738 prescribers have prescribed Morphine.Sulfate.Er - 6.952% of Prescribers


# 08. Oxycodone.Acetaminophen

prescribers_oxycodone.acetaminophen <- prescribers$OXYCODONE.ACETAMINOPHEN >= 1

summary(prescribers_oxycodone.acetaminophen)

# 4922 prescribers have prescribed Oxycodone.Acetaminophen at least once

percent_prescribers_oxycodone.acetaminophen <- (4922/prescriber_numbers)*100

print(percent_prescribers_oxycodone.acetaminophen)

# 4922 prescribers have prescribed Oxycodone.Acetaminophen - 19.688% of Prescribers


# 09. Oxycodone.HCL

prescribers_oxycodone.hcl <- prescribers$OXYCODONE.HCL >= 1

summary(prescribers_oxycodone.hcl)

# 2945 prescribers have prescribed Oxycodone.HCL at least once

percent_presrcibers_oxycodone.hcl <- (2945/prescriber_numbers)*100

print(percent_presrcibers_oxycodone.hcl)

# 2945 prescribers have prescribed Oxycodone.HCL - 11.78% of Prescribers


# 10. Oxycontin

prescribers_oxycontin <- prescribers$OXYCONTIN >= 1

summary(prescribers_oxycontin)

# 1294 prescribers have prescribed Oxycontin at least once

percent_prescribers_oxycontin <- (1294/prescriber_numbers)*100

print(percent_prescribers_oxycontin)

# 1294 prescribers have prescribed Oxycodone.HCL - 5.176% of Prescribers


# 11. Tramadol.HCL

prescribers_tramadol.hcl <- prescribers$TRAMADOL.HCL >= 1

summary(prescribers_tramadol.hcl)

# 6633 prescribers have prescribed Tramadol.HCL at least once

percent_prescribers_tramadol.hcl <- (6633/prescriber_numbers)*100

print(percent_prescribers_tramadol.hcl)

# 6633 prescribers have prescribed Tramadol.HCL - 26.532% of Prescribers


# Create a data frame of % prescribers prescribing each opioid and plot it

drug_name <- c('Acetaminophen.Codeine', 'Fentanyl', 'Hydrocodone.Acetaminophen', 'Hydromorphone.HCL', 'Methadone.HCL', 'Morphine.Sulfate', 'Morphine.Sulfate.ER', 'Oxycodone.Acetaminophen', 'Oxycodone.HCL', 'Oxycontin', 'Tramadol.HCL')

percent_prescribers_drug_name <- c(8.532, 7.86, 40.176, 2.888, 3.46, 2.696, 6.952, 19.688, 11.78, 5.176, 26.532)

opioids_prescriber_breakdown <- data.frame(drug_name, percent_prescribers_drug_name)

# plot using ggplot2

q <- qplot(drug_name, percent_prescribers_drug_name, data=opioids_prescriber_breakdown, geom="boxplot")

q + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "% of prescribers", limits=c(0,100)) + scale_x_discrete(name="Opioid")

#q + theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

# Step 2: Explore trends in prescriptions from healthcare professionals
#I will use the Prescribers datasets to gather more information on the healthcare professionals that are prescribing such opioid medications.
#I will examine trends on whether particular types of healthcare professionals are prescribing more opioid medications than others, and whether this varies by U.S. state.


```{r}
# Get Descriptive Stats for Prescribers who are prescribing Opiods - (i) Gender, (ii) State, (iii) Specialty

# (i) Gender - Descriptive Stats on Gender linked to Prescribers who are prescribing Opioids

prescribers_gender <- prescribers$Gender
View(prescribers_gender)

# Convert to Data Frame

prescribers_gender_df <- as.data.frame(prescribers_gender)

# Breakdown of Gender of prescribers prescribing opioids

prescriber_gender_opioids <- filter(prescribers_gender_df, (prescribers$ACETAMINOPHEN.CODEINE >= 1) | (prescribers$FENTANYL >= 1) | (prescribers$HYDROCODONE.ACETAMINOPHEN >= 1) | (prescribers$HYDROMORPHONE.HCL >= 1) | (prescribers$METHADONE.HCL >= 1) | (prescribers$MORPHINE.SULFATE >= 1) | (prescribers$MORPHINE.SULFATE.ER >= 1) | (prescribers$OXYCODONE.ACETAMINOPHEN >= 1) | (prescribers$OXYCODONE.HCL >= 1)|(prescribers$OXYCONTIN >= 1) | (prescribers$TRAMADOL.HCL >= 1))

summary(prescriber_gender_opioids)

### Results ###

 #prescribers_gender
 #F:4368            
 #M:8432

## Plot Results

plot(prescriber_gender_opioids, xlab="Gender", ylab="# of prescribers", col=c("red","blue"), ylim=c(0,10000), main="Sex Breakdown of Opioid Prescribers")


# (ii) State - Descriptive Stats on State linked to Prescribers who are prescribing Opioids

prescribers_state <- prescribers$State
View(prescribers_state)

# Convert to Data Frame

prescribers_state_df <- as.data.frame(prescribers_state)

# Breakdown of Gender of prescribers prescribing opioids

prescriber_state_opioids <- filter(prescribers_state_df, (prescribers$ACETAMINOPHEN.CODEINE >= 1) | (prescribers$FENTANYL >= 1) | (prescribers$HYDROCODONE.ACETAMINOPHEN >= 1) | (prescribers$HYDROMORPHONE.HCL >= 1) | (prescribers$METHADONE.HCL >= 1) | (prescribers$MORPHINE.SULFATE >= 1) | (prescribers$MORPHINE.SULFATE.ER >= 1) | (prescribers$OXYCODONE.ACETAMINOPHEN >= 1) | (prescribers$OXYCODONE.HCL >= 1)|(prescribers$OXYCONTIN >= 1) | (prescribers$TRAMADOL.HCL >= 1))

summary(prescriber_state_opioids)

### Results ###

 #prescribers_state
 #CA     :1293     
 #TX     : 864     
 #FL     : 750     
 #NY     : 711     
 #PA     : 587     
 #OH     : 503     
 #(Other):8092

# These are raw #s - need to use state population levels from Overdoses death to generate per capita levels

# Plot

prescriber_state_opioids_plot <- qplot(prescriber_state_opioids$prescribers_state, geom="bar", width="0.1")

prescriber_state_opioids_plot + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=1, size=5)) + scale_y_continuous(name = "# of opioid prescribers") + scale_x_discrete(name="States")

# (iii) Specialty - Descriptive Stats on Specialty linked to Prescribers who are prescribing Opioids

prescribers_specialty <- prescribers$Specialty
View(prescribers_specialty)

# Convert to Data Frame

prescribers_specialty_df <- as.data.frame(prescribers_specialty)

# Breakdown of prescribers prescribing opioids

prescriber_specialty_opioids <- filter(prescribers_specialty_df, (prescribers$ACETAMINOPHEN.CODEINE >= 1) | (prescribers$FENTANYL >= 1) | (prescribers$HYDROCODONE.ACETAMINOPHEN >= 1) | (prescribers$HYDROMORPHONE.HCL >= 1) | (prescribers$METHADONE.HCL >= 1) | (prescribers$MORPHINE.SULFATE >= 1) | (prescribers$MORPHINE.SULFATE.ER >= 1) | (prescribers$OXYCODONE.ACETAMINOPHEN >= 1) | (prescribers$OXYCODONE.HCL >= 1)|(prescribers$OXYCONTIN >= 1) | (prescribers$TRAMADOL.HCL >= 1))

tabulate_prescriber_specialty_opioids <- table(prescriber_specialty_opioids)

View(tabulate_prescriber_specialty_opioids)

# 109 different types of healthcare professionals.

# Too large to lot. Determine top 5 and plot those

summary(prescriber_specialty_opioids)

### Results ###

 #Family Practice    :2410     
 #Internal Medicine  :2078     
 #Nurse Practitioner :1165     
 #Physician Assistant:1114     
 #Emergency Medicine : 992     
 #Dentist            : 817     
 #(Other)            :4224 

# Create new Data Frame for top 5

prescriber_name <- c('Family Practice', 'Internal Medicine', 'Nurse Practitioner', 'Physician Assistant', 'Emergency Medicine')

prescriber_numbers <- c(2410, 2078, 1165, 1114, 992)

opioid_specialty_top5 <- data.frame(prescriber_name, prescriber_numbers)

opioid_specialty_top5_plot <- qplot(prescriber_name, prescriber_numbers, data=opioid_specialty_top5, geom="boxplot")

opioid_specialty_top5_plot + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers") + scale_x_discrete(name = "Specialty")

## Overall Summary

## Prescribers that prescribe opioids are more likely to be male than female

## The top 5 states where opioid-prescribing prescribers are California, Texas, Florida, New York, and Pennsylvania

## The top 5 medical specialties for prescribing opioids are Family Practice, Internal Medicine, Nurse Practitioner, Physician Assistant, and Emergency Medicine

```

# Step 3
# Finally, after gathering information from exploring information related to opioid medications & healthcare professionals that prescribe such compounds, I will aim to develop a predictive model (e.g., regression analysis) between opioid prescriptions and opioid-related overdose fatalities. 

```{r}

# I now have information about opioid prescriptions and the prescribers prescribing those opioids

# I want to relate opioids prescriptions/prescriber info to overdose levels

# Overdoses include information on State Name, State Population, Opioid-related Overdose Deaths, State Abbreviation

# Suggesting to perform a linear regression - I want to predict opioid-related overdose deaths from opioid prescription levels per state

# I will use the lm function

# Sum up aross 11 opioids per prescriber

colnms=c("ACETAMINOPHEN.CODEINE", "FENTANYL", "HYDROCODONE.ACETAMINOPHEN", "HYDROMORPHONE.HCL", "METHADONE.HCL", "MORPHINE.SULFATE", "MORPHINE.SULFATE.ER", "OXYCODONE.ACETAMINOPHEN", "OXYCODONE.HCL", "OXYCONTIN", "TRAMADOL.HCL")

prescriber_opioids_sum <- prescriber_opioids$summary <- rowSums(prescriber_opioids[,colnms])

# Extract out "State" and "summary" columns

prescriber_state_summary <- subset(prescriber_opioids, select = c("State", "summary"))

# Sum per State

prescriber_state_overall_sum <- aggregate(prescriber_state_summary$summary, by=list(prescriber_state_summary$State), FUN=sum)

# Delete rows that don't match up with States in Overdoses file - from visual inspection there are 6 - AE, DC, GU, PR, VI, ZZ

final_prescriber_state_opioid_sum <- prescriber_state_overall_sum[-c(1,9,13,42,50,56), ]

# States in Presciber File are in Alphabetical Order but States in Overdose File are not - need to order States

overdoses_states_ordered <- overdoses[order(overdoses$Abbrev),]

#Need to take out comma from Deaths column in overdoses_states_ordered

overdose_deaths <- overdoses_states_ordered$Deaths

overdose_deaths_no_comma <- gsub(",", "", overdose_deaths)

# Check if file is numeric

is.numeric(overdose_deaths_no_comma)

overdose_deaths_numeric <- as.numeric(overdose_deaths_no_comma)

# Create data frame

states_ordered_prescription_overdose <- data.frame(final_prescriber_state_opioid_sum$x, overdose_deaths_numeric)

#Run linear regresson (Deaths is DV, Opioids Prescriptions per State is IV)

prescriptions_overdoses_lm <- lm(formula = overdose_deaths_numeric ~ final_prescriber_state_opioid_sum.x, data=states_ordered_prescription_overdose)

summary(prescriptions_overdoses_lm)

## Results ##

# Call:
# lm(formula = overdose_deaths_numeric ~ final_prescriber_state_opioid_sum.x, 
#     data = states_ordered_prescription_overdose)

# Residuals:
#     Min      1Q  Median      3Q     Max 
# -602.13 -152.10  -25.87  174.82  816.64 
# 
# Coefficients:
#                                      Estimate Std. Error
# (Intercept)                         64.033622  65.909497
# final_prescriber_state_opioid_sum.x  0.020553   0.001122
#                                     t value Pr(>|t|)    
# (Intercept)                           0.972    0.336    
# final_prescriber_state_opioid_sum.x  18.317   <2e-16 ***
# ---
# Signif. codes:  
# 0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Residual standard error: 321 on 48 degrees of freedom
# Multiple R-squared:  0.8748,	Adjusted R-squared:  0.8722 
# F-statistic: 335.5 on 1 and 48 DF,  p-value: < 2.2e-16



```


```{r}



```



```{r}

```


```{r}

```



