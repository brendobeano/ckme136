---
title: "CKME136 Capstone Project"
author: "Brendan Behan"
date: '2020-04-06'
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# # Set up R and Import 3 files (Opioids, Prescribers, Overdoses)

```{r}
install.packages("class", repos="http://cran.us.r-project.org")
install.packages("gmodels", repos="http://cran.us.r-project.org")
install.packages("biganalytics", repos="http://cran.us.r-project.org")
library(class)
library(gmodels)
library(ggplot2)
library(biganalytics)
library(dplyr)

opioids <- read.csv("C:/Users/bbehan/Desktop/ckme136/data/opioids.csv")
prescribers <- read.csv("C:/Users/bbehan/Desktop/ckme136/data/prescriber-info.csv")
overdoses <- read.csv("C:/Users/bbehan/Desktop/ckme136/data/overdoses.csv")

# check that files are loaded as data frames in R
df <- data.frame()
is.data.frame(opioids)
is.data.frame(prescribers)
is.data.frame(overdoses)

# check for missing values

sum(is.na(opioids))
sum(is.na(prescribers))
sum(is.na(overdoses))

```

# Explore datasets
# Opioids
# Prescribers
# Overdoses

```{r}
# Look at characteristics of Opioids file
summary(opioids)
head(opioids)
tail(opioids)

#There are 113 entries - with 5 instances of repetitions
```
```{r}
# Look at characteristics of Prescribers file
summary(prescribers)
head(prescribers)
tail(prescribers)

#There are 25,000 entries - with 256 columns per entry
```
```{r}
# Look at characteristics of Overdoses file
summary(overdoses)
head(overdoses)
tail(overdoses)

#There are 50 rows (one per US state) showing overall state population and # of deaths
```
#Step 1: Explore trends in opioid prescriptions
#The Opioids dataset will be used to pull out opioid prescriptions from the Prescribers dataset.

```{r}

## I want to take the drug names(first column) from the Opioids fileand cross-reference it with all the drug names (header) in the Prescribers file 

##Take out header information from Prescribers file and compare it to Opioids file

names(prescribers)
prescribers_column_names <- data.frame(names(prescribers))
is.data.frame(prescribers_column_names)

## View files to get column names

View(prescribers_column_names)
View(opioids)

##Compare drugs listed from Prescribers file with Opioids file

## Merge Function

identified_opioids <- merge(x=prescribers_column_names, y=opioids, by.x='names.prescribers.', by.y='Drug.Name')

View(identified_opioids)

#2 opioids identified - Fentanyl and Oxycontin. However, from visually inspecting datasets there should be more overlap, need to go back and clean datasets further (e.g., naming conventions)

# Clean up Opioid Dataset to replace spaces and hyphens with periods

opioids_drug.name <- opioids$Drug.Name

opioids_replace_space <- gsub(" ", ".", opioids_drug.name)

opioids_replace_space_and_hyphen <- gsub("-", ".", opioids_replace_space)

View(opioids_replace_space_and_hyphen)

# change name to show that opioids dataset have now been cleaned

opioids_cleaned <- opioids_replace_space_and_hyphen

# Re-run previous merge command

opioids_cleaned_df <- data.frame(opioids_cleaned)

identified_opioids_cleaned <- merge(x=prescribers_column_names, y=opioids_cleaned_df, by.x='names.prescribers.', by.y='opioids_cleaned')

View(identified_opioids_cleaned)

# 13 opioids identified - however 2 drugs are repeated - HYDROMORPHONE.HCL and MORPHINE.SULFATE

# Therefore, 11 of the 250 medications in the Prescribers file are opioids


# Determine how many prescribers have prescribed at least one of these opioids

prescriber_numbers <- nrow(prescribers)

print(prescriber_numbers)

# 25000 prescribers identified

# Identify which prescribers have prescribed at least one of the 11 listed opioids

prescriber_opioids <- filter(prescribers, (prescribers$ACETAMINOPHEN.CODEINE >= 1) | (prescribers$FENTANYL >= 1) | (prescribers$HYDROCODONE.ACETAMINOPHEN >= 1) | (prescribers$HYDROMORPHONE.HCL >= 1) | (prescribers$METHADONE.HCL >= 1) | (prescribers$MORPHINE.SULFATE >= 1) | (prescribers$MORPHINE.SULFATE.ER >= 1) | (prescribers$OXYCODONE.ACETAMINOPHEN >= 1) | (prescribers$OXYCODONE.HCL >= 1) | (prescribers$OXYCONTIN >= 1) | (prescribers$TRAMADOL.HCL >= 1))

nrow(prescriber_opioids)

# 12800 of listed 25000 prescribers have prescribed at least one of the 11 opioids

# Get %

percentage_prescribers_opioids <- nrow(prescriber_opioids) / prescriber_numbers * 100

print(percentage_prescribers_opioids)

# 51.2 % of prescribers have prescribed at least one opioid

# Breakdown per opioid

# 01. Acetaminophen.Codeine

prescribers_acetaminophen.codeine <- prescribers$ACETAMINOPHEN.CODEINE >= 1

summary(prescribers_acetaminophen.codeine)

# 2133 prescribers have prescribed Acetaminophen.Codeine at least once

percent_prescribers_acetaminophen.codeine <- (2133/prescriber_numbers)*100

print(percent_prescribers_acetaminophen.codeine)

# 2133 prescribers have prescribed Acetaminophen.Codeine - 8.532% of Prescribers

# 02. Fentanyl

prescribers_fentanyl <- prescribers$FENTANYL >= 1
summary(prescribers_fentanyl)

# 1965 prescribers have prescribed Fentanyl at least once

percent_prescribers_fentanyl <- (1965/prescriber_numbers)*100

print(percent_prescribers_fentanyl)

# 1965 prescribers have prescribed Fentanyl - 7.86% of Prescribers

# 03. Hydrocodone.Acetaminophen

prescribers_hydrocodone.acetaminophen <- prescribers$HYDROCODONE.ACETAMINOPHEN >= 1
summary(prescribers_hydrocodone.acetaminophen)

# 10044 prescribers have prescribed Hydrocodone.Acetaminophen at least once

percent_prescribers_hydrocodone.acetaminophen <- (10044/prescriber_numbers)*100

print(percent_prescribers_hydrocodone.acetaminophen)

# 10044 prescribers have prescribed Hydrocodone.Acetaminophen - 40.176% of Prescribers

# 04. Hydromorphone.HCL

prescribers_hydromorphone.HCL <- prescribers$HYDROMORPHONE.HCL >= 1

summary(prescribers_hydromorphone.HCL)

# 722 prescribers have prescribed Hydromorphone.HCL at least once

percent_prescribers_hydromorphone.HCL <- (722/prescriber_numbers)*100

print(percent_prescribers_hydromorphone.HCL)

# 722 prescribers have prescribed Hydromorphone.HCL - 2.888% of Prescribers

# 05. Methadone.HCL

prescribers_methadone.HCL <- prescribers$METHADONE.HCL >= 1

summary(prescribers_methadone.HCL)

# 865 prescribers have prescribed Methadone.HCL at least once

percent_prescribers_methadone.HCL <- (865/prescriber_numbers)*100

print(percent_prescribers_methadone.HCL)

# 865 prescribers have prescribed Methadone.HCL - 3.46% of Prescribers

# 06. Morphine.Sulfate

prescribers_morphine.sulfate <- prescribers$MORPHINE.SULFATE >= 1

summary(prescribers_morphine.sulfate)

# 674 prescribers have prescribed Morphine.Sulfate at least once

percent_prescribers_morphine.sulfate <- (674/prescriber_numbers)*100

print(percent_prescribers_morphine.sulfate)

# 674 prescribers have prescribed Morphine.Sulfate - 2.696% of Prescribers


# 07. Morphine.Sulfate.ER

prescribers_morphine.sulfate.er <- prescribers$MORPHINE.SULFATE.ER >= 1

summary(prescribers_morphine.sulfate.er)

# 1738 prescribers have prescribed Morphine.Sulfate.Er at least once

percent_prescribers_morphine.sulfate.er <- (1738/prescriber_numbers)*100

print(percent_prescribers_morphine.sulfate.er)

# 1738 prescribers have prescribed Morphine.Sulfate.Er - 6.952% of Prescribers


# 08. Oxycodone.Acetaminophen

prescribers_oxycodone.acetaminophen <- prescribers$OXYCODONE.ACETAMINOPHEN >= 1

summary(prescribers_oxycodone.acetaminophen)

# 4922 prescribers have prescribed Oxycodone.Acetaminophen at least once

percent_prescribers_oxycodone.acetaminophen <- (4922/prescriber_numbers)*100

print(percent_prescribers_oxycodone.acetaminophen)

# 4922 prescribers have prescribed Oxycodone.Acetaminophen - 19.688% of Prescribers


# 09. Oxycodone.HCL

prescribers_oxycodone.hcl <- prescribers$OXYCODONE.HCL >= 1

summary(prescribers_oxycodone.hcl)

# 2945 prescribers have prescribed Oxycodone.HCL at least once

percent_presrcibers_oxycodone.hcl <- (2945/prescriber_numbers)*100

print(percent_presrcibers_oxycodone.hcl)

# 2945 prescribers have prescribed Oxycodone.HCL - 11.78% of Prescribers


# 10. Oxycontin

prescribers_oxycontin <- prescribers$OXYCONTIN >= 1

summary(prescribers_oxycontin)

# 1294 prescribers have prescribed Oxycontin at least once

percent_prescribers_oxycontin <- (1294/prescriber_numbers)*100

print(percent_prescribers_oxycontin)

# 1294 prescribers have prescribed Oxycodone.HCL - 5.176% of Prescribers


# 11. Tramadol.HCL

prescribers_tramadol.hcl <- prescribers$TRAMADOL.HCL >= 1

summary(prescribers_tramadol.hcl)

# 6633 prescribers have prescribed Tramadol.HCL at least once

percent_prescribers_tramadol.hcl <- (6633/prescriber_numbers)*100

print(percent_prescribers_tramadol.hcl)

# 6633 prescribers have prescribed Tramadol.HCL - 26.532% of Prescribers


# Create a data frame of % prescribers prescribing each opioid and plot it

drug_name <- c('Acetaminophen.Codeine', 'Fentanyl', 'Hydrocodone.Acetaminophen', 'Hydromorphone.HCL', 'Methadone.HCL', 'Morphine.Sulfate', 'Morphine.Sulfate.ER', 'Oxycodone.Acetaminophen', 'Oxycodone.HCL', 'Oxycontin', 'Tramadol.HCL')

percent_prescribers_drug_name <- c(8.532, 7.86, 40.176, 2.888, 3.46, 2.696, 6.952, 19.688, 11.78, 5.176, 26.532)

opioids_prescriber_breakdown <- data.frame(drug_name, percent_prescribers_drug_name)

# Order Opioids Prescriber Breakdown - Ascending to Descending

ordered_opioids_prescriber_breakdown <- arrange(opioids_prescriber_breakdown, desc(percent_prescribers_drug_name))

# plot using ggplot

plot_opioids_prescriber_breakdown <- ggplot(data = ordered_opioids_prescriber_breakdown,mapping= aes(x = reorder(drug_name, -percent_prescribers_drug_name), percent_prescribers_drug_name)) + geom_bar(stat = "identity")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "% of prescribers", limits=c(0,45)) + scale_x_discrete(name="Opioid") + ggtitle("% of Healthcare Professionals Prescribing Opioids") + theme(plot.title = element_text(hjust = 0.5))

plot_opioids_prescriber_breakdown

```

# Step 2: Explore trends in prescriptions from healthcare professionals
#I will use the Prescribers datasets to gather more information on the healthcare professionals that are prescribing such opioid medications.
#I will examine trends on whether particular types of healthcare professionals are prescribing more opioid medications than others, and whether this varies by U.S. state.


```{r}
# Get Descriptive Stats for Prescribers who are prescribing Opiods - (i) Gender, (ii) State, (iii) Specialty

# (i) Gender - Descriptive Stats on Gender linked to Prescribers who are prescribing Opioids

prescribers_gender <- prescribers$Gender
View(prescribers_gender)

# Convert to Data Frame

prescribers_gender_df <- as.data.frame(prescribers_gender)

# Breakdown of Gender of prescribers prescribing opioids

prescriber_gender_opioids <- filter(prescribers_gender_df, (prescribers$ACETAMINOPHEN.CODEINE >= 1) | (prescribers$FENTANYL >= 1) | (prescribers$HYDROCODONE.ACETAMINOPHEN >= 1) | (prescribers$HYDROMORPHONE.HCL >= 1) | (prescribers$METHADONE.HCL >= 1) | (prescribers$MORPHINE.SULFATE >= 1) | (prescribers$MORPHINE.SULFATE.ER >= 1) | (prescribers$OXYCODONE.ACETAMINOPHEN >= 1) | (prescribers$OXYCODONE.HCL >= 1)|(prescribers$OXYCONTIN >= 1) | (prescribers$TRAMADOL.HCL >= 1))

summary(prescriber_gender_opioids)

### Results ###

 #prescribers_gender
 #F:4368            
 #M:8432

## Plot Results

plot(prescriber_gender_opioids, xlab="Gender", ylab="# of prescribers", col=c("red","blue"), ylim=c(0,10000), main="Sex Breakdown of Opioid Prescribers")


# (ii) State - Descriptive Stats on State linked to Prescribers who are prescribing Opioids

prescribers_state <- prescribers$State
View(prescribers_state)

# Convert to Data Frame

prescribers_state_df <- as.data.frame(prescribers_state)

# Breakdown of Gender of prescribers prescribing opioids

prescriber_state_opioids <- filter(prescribers_state_df, (prescribers$ACETAMINOPHEN.CODEINE >= 1) | (prescribers$FENTANYL >= 1) | (prescribers$HYDROCODONE.ACETAMINOPHEN >= 1) | (prescribers$HYDROMORPHONE.HCL >= 1) | (prescribers$METHADONE.HCL >= 1) | (prescribers$MORPHINE.SULFATE >= 1) | (prescribers$MORPHINE.SULFATE.ER >= 1) | (prescribers$OXYCODONE.ACETAMINOPHEN >= 1) | (prescribers$OXYCODONE.HCL >= 1)|(prescribers$OXYCONTIN >= 1) | (prescribers$TRAMADOL.HCL >= 1))

summary(prescriber_state_opioids)

# Count frequency occurrence of state and turn into Data Frame

table_prescriber_state_opioids <- table(prescriber_state_opioids)

# Check if Data Frame 

is.data.frame(table_prescriber_state_opioids)

# Create as Data Frame

df_prescriber_state_opioids <- data.frame(table_prescriber_state_opioids)

# Plot

plot_df_prescriber_state_opioids <- ggplot(data = df_prescriber_state_opioids,mapping= aes(x = reorder(prescriber_state_opioids, -Freq), Freq)) + geom_bar(stat = "identity")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers", limits=c(0,1500)) + scale_x_discrete(name="States") + ggtitle("State Breakdown of Opioid Prescribers") + theme(plot.title = element_text(hjust = 0.5))

plot_df_prescriber_state_opioids

# Plot states with highest level of prescriber #s

summary(df_prescriber_state_opioids)

df_prescriber_state_opioids_3rd_quartile <- filter(df_prescriber_state_opioids, (df_prescriber_state_opioids$Freq >= 291))

## Plot

plot_df_prescriber_state_opioids_3rd_quartile <- ggplot(data = df_prescriber_state_opioids_3rd_quartile,mapping= aes(x = reorder(prescriber_state_opioids, -Freq), Freq)) + geom_bar(stat = "identity")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers", limits=c(0,1500)) + scale_x_discrete(name="States") + ggtitle("State Breakdown of Opioid Prescribers - Upper Quartile") + theme(plot.title = element_text(hjust = 0.5))

plot_df_prescriber_state_opioids_3rd_quartile

## Calculate per capita

### Results ###

 #prescribers_state
 #CA     :1293     
 #TX     : 864     
 #FL     : 750     
 #NY     : 711     
 #PA     : 587     
 #OH     : 503     
 #(Other):8092

# These are raw #s - need to use state population levels from Overdoses death to generate per capita levels

# Plot

# Want to use State Population levels from Overdoses File

# Need to delete 7 state entries (AA, AE, DC, GU, PR, VI, ZZ) from df_prescriber_state_opioids so that it matches the states in Overdoses file

cleaned_df_prescriber_state_opioids <- df_prescriber_state_opioids[-c(1, 2,10,14,43,51,57), ]

# Clean overdoses file

# States in Presciber File are in Alphabetical Order but States in Overdose File are not - need to order States

overdoses_states_ordered <- overdoses[order(overdoses$Abbrev),]

overdose_states_ordered_cleaned_population <- gsub(",", "", overdoses_states_ordered$Population)

overdose_states_ordered_cleaned_deaths <- gsub(",", "", overdoses_states_ordered$Deaths)

# Create Data Frame

per_capita_state_opioids <- data.frame(cleaned_df_prescriber_state_opioids, overdose_states_ordered_cleaned_population, overdose_states_ordered_cleaned_deaths)

# Per Capita Opioids - Population

per_capita_opioid_populations <- per_capita_state_opioids$Freq / as.numeric(as.character(per_capita_state_opioids$overdose_states_ordered_cleaned_population))

# Per Capita Deaths - Population

per_capita_deaths_populations <- as.numeric(as.character(per_capita_state_opioids$overdose_states_ordered_cleaned_deaths)) / as.numeric(as.character(per_capita_state_opioids$overdose_states_ordered_cleaned_population))

# Create Data Frame

final_per_capita_state_opioids <- data.frame(per_capita_state_opioids$prescriber_state_opioids, per_capita_opioid_populations)

# Plot

plot_per_capita_prescriber_state_opioids <- ggplot(data = final_per_capita_state_opioids,mapping= aes(x = reorder(per_capita_state_opioids.prescriber_state_opioids, -per_capita_opioid_populations), per_capita_opioid_populations)) + geom_bar(stat = "identity")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers") + scale_x_discrete(name="States") + ggtitle("State Breakdown of Opioid Prescribers - Per Capita") + theme(plot.title = element_text(hjust = 0.5))

plot_per_capita_prescriber_state_opioids

# Plot states with highest level of prescriber #s

summary(final_per_capita_state_opioids)

# Filter by 3rd Quartile level - 4.695e-05

df_final_per_capita_state_opioids_3rd_quartile <- filter(final_per_capita_state_opioids, (final_per_capita_state_opioids$per_capita_opioid_populations >= 4.695e-05))

plot_per_capita_prescriber_state_opioids_3rd_quartile <- ggplot(data = df_final_per_capita_state_opioids_3rd_quartile,mapping= aes(x = reorder(per_capita_state_opioids.prescriber_state_opioids, -per_capita_opioid_populations), per_capita_opioid_populations)) + geom_bar(stat = "identity")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers") + scale_x_discrete(name="States") + ggtitle("State Breakdown of Opioid Prescribers - Per Capita - Upper Quartile") + theme(plot.title = element_text(hjust = 0.5))

plot_per_capita_prescriber_state_opioids_3rd_quartile


# (iii) Specialty - Descriptive Stats on Specialty linked to Prescribers who are prescribing Opioids

prescribers_specialty <- prescribers$Specialty
View(prescribers_specialty)

# Convert to Data Frame

prescribers_specialty_df <- as.data.frame(prescribers_specialty)

# Breakdown of prescribers prescribing opioids

prescriber_specialty_opioids <- filter(prescribers_specialty_df, (prescribers$ACETAMINOPHEN.CODEINE >= 1) | (prescribers$FENTANYL >= 1) | (prescribers$HYDROCODONE.ACETAMINOPHEN >= 1) | (prescribers$HYDROMORPHONE.HCL >= 1) | (prescribers$METHADONE.HCL >= 1) | (prescribers$MORPHINE.SULFATE >= 1) | (prescribers$MORPHINE.SULFATE.ER >= 1) | (prescribers$OXYCODONE.ACETAMINOPHEN >= 1) | (prescribers$OXYCODONE.HCL >= 1)|(prescribers$OXYCONTIN >= 1) | (prescribers$TRAMADOL.HCL >= 1))

tabulate_prescriber_specialty_opioids <- table(prescriber_specialty_opioids)

View(tabulate_prescriber_specialty_opioids)

# Convert to a Data Frame

df_tabulate_prescriber_specialty_opioids <- data.frame(tabulate_prescriber_specialty_opioids)

# 109 different types of healthcare professionals.

plot_df_prescriber_specialty_opioids <- ggplot(data = df_tabulate_prescriber_specialty_opioids,mapping= aes(x = reorder(prescriber_specialty_opioids, -Freq), Freq)) + geom_bar(stat = "identity")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers") + scale_x_discrete(name="Specialty") + ggtitle("Specialty Breakdown of Opioid Prescribers") + theme(plot.title = element_text(hjust = 0.5))

plot_df_prescriber_specialty_opioids

# Too large to lot. Look at Summary and 3rd quartile

summary(df_tabulate_prescriber_specialty_opioids)

# Q3 = 54.0

df_prescriber_specialty_opioids_3rd_quartile <- filter(df_tabulate_prescriber_specialty_opioids, (df_tabulate_prescriber_specialty_opioids$Freq >= 54.0))

plot_df_prescriber_specialty_opioids_3rd_quartile <- ggplot(data = df_prescriber_specialty_opioids_3rd_quartile,mapping= aes(x = reorder(prescriber_specialty_opioids, -Freq), Freq)) + geom_bar(stat = "identity")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers") + scale_x_discrete(name="Specialty") + ggtitle("Specialty Breakdown of Opioid Prescribers - Upper Quartile") + theme(plot.title = element_text(hjust = 0.5))

plot_df_prescriber_specialty_opioids_3rd_quartile


# look at top 8

sum_top_8 <- sum(df_tabulate_prescriber_specialty_opioids$Freq[25], df_tabulate_prescriber_specialty_opioids$Freq[42], df_tabulate_prescriber_specialty_opioids$Freq[63], df_tabulate_prescriber_specialty_opioids$Freq[81], df_tabulate_prescriber_specialty_opioids$Freq[22], df_tabulate_prescriber_specialty_opioids$Freq[19], df_tabulate_prescriber_specialty_opioids$Freq[70], df_tabulate_prescriber_specialty_opioids$Freq [29])

sum_top_8_percent <- (sum_top_8/12800) * 100

View(sum_top_8_percent)

# top 8 account for ~74.57% of dataset - lowest value is 420

df_prescriber_specialty_opioids_top_8 <- filter(df_tabulate_prescriber_specialty_opioids, (df_tabulate_prescriber_specialty_opioids$Freq >= 420.0))

plot_df_prescriber_specialty_opioids_top_8 <- ggplot(data = df_prescriber_specialty_opioids_top_8,mapping= aes(x = reorder(prescriber_specialty_opioids, -Freq), Freq)) + geom_bar(stat = "identity")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers") + scale_x_discrete(name="Specialty") + ggtitle("Specialty Breakdown of Opioid Prescribers - Top 8") + theme(plot.title = element_text(hjust = 0.5))

plot_df_prescriber_specialty_opioids_top_8 

summary(prescriber_specialty_opioids)

### Results ###

 #Family Practice    :2410     
 #Internal Medicine  :2078     
 #Nurse Practitioner :1165     
 #Physician Assistant:1114     
 #Emergency Medicine : 992     
 #Dentist            : 817     
 #(Other)            :4224 

# Create new Data Frame for top 5

prescriber_name <- c('Family Practice', 'Internal Medicine', 'Nurse Practitioner', 'Physician Assistant', 'Emergency Medicine')

prescriber_numbers <- c(2410, 2078, 1165, 1114, 992)

opioid_specialty_top5 <- data.frame(prescriber_name, prescriber_numbers)

opioid_specialty_top5_plot <- qplot(prescriber_name, prescriber_numbers, data=opioid_specialty_top5, geom="boxplot")

opioid_specialty_top5_plot + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers") + scale_x_discrete(name = "Specialty")

## Overall Summary

## Prescribers that prescribe opioids are more likely to be male than female

## The top 5 states where opioid-prescribing prescribers are California, Texas, Florida, New York, and Pennsylvania

## The top 5 medical specialties for prescribing opioids are Family Practice, Internal Medicine, Nurse Practitioner, Physician Assistant, and Emergency Medicine

```

# Step 3
# Finally, after gathering information from exploring information related to opioid medications & healthcare professionals that prescribe such compounds, I will aim to develop a predictive model (e.g., regression analysis) between opioid prescriptions and opioid-related overdose fatalities. 

```{r}
## (i) Sex/States vs. Opioid Prescriptions

## Run Multiple Linear Regression

# DV = levels of opioid prescription

# Multiple IV

# 01. Gender
# 02. State

# Sum up aross 11 opioids per prescriber

colnms=c("ACETAMINOPHEN.CODEINE", "FENTANYL", "HYDROCODONE.ACETAMINOPHEN", "HYDROMORPHONE.HCL", "METHADONE.HCL", "MORPHINE.SULFATE", "MORPHINE.SULFATE.ER", "OXYCODONE.ACETAMINOPHEN", "OXYCODONE.HCL", "OXYCONTIN", "TRAMADOL.HCL")

prescriber_opioids$summary <- rowSums(prescriber_opioids[,colnms])

# Multivariate Linear Regression - Gender and State

opioid_prescriptions_gender_state_lm <- lm(formula = summary ~ Gender + State, data=prescriber_opioids)

summary(opioid_prescriptions_gender_state_lm)

# Call:
# lm(formula = summary ~ Gender + State, data = prescriber_opioids)
# 
# Residuals:
#     Min      1Q  Median      3Q     Max 
#  -297.7  -141.6   -90.1     4.9 15018.0 
# 
# Coefficients:
#             Estimate Std. Error t value Pr(>|t|)    
# (Intercept)  205.888    264.829   0.777    0.437    
# GenderM       51.224      7.042   7.274 3.69e-13 ***
# StateAK     -188.379    276.587  -0.681    0.496    
# StateAL       26.280    265.975   0.099    0.921    
# StateAR      -30.118    266.658  -0.113    0.910    
# StateAZ      -56.182    265.740  -0.211    0.833    
# StateCA      -89.645    265.012  -0.338    0.735    
# StateCO     -121.178    266.058  -0.455    0.649    
# StateCT     -154.722    266.457  -0.581    0.561    
# StateDC     -193.136    274.438  -0.704    0.482    
# StateDE     -107.222    271.039  -0.396    0.692    
# StateFL      -41.104    265.164  -0.155    0.877    
# StateGA      -30.132    265.561  -0.113    0.910    
# StateGU     -240.112    458.670  -0.523    0.601    
# StateHI     -143.978    272.268  -0.529    0.597    
# StateIA      -63.449    267.203  -0.237    0.812    
# StateID      -88.699    268.097  -0.331    0.741    
# StateIL     -100.333    265.337  -0.378    0.705    
# StateIN        2.734    265.717   0.010    0.992    
# StateKS      -43.897    267.061  -0.164    0.869    
# StateKY      -12.781    266.283  -0.048    0.962    
# StateLA       51.556    266.106   0.194    0.846    
# StateMA     -107.656    265.634  -0.405    0.685    
# StateMD     -110.861    265.831  -0.417    0.677    
# StateME      -90.159    268.015  -0.336    0.737    
# StateMI      -58.837    265.353  -0.222    0.825    
# StateMN     -103.547    266.029  -0.389    0.697    
# StateMO      -52.387    265.842  -0.197    0.844    
# StateMS       -1.898    266.974  -0.007    0.994    
# StateMT      -90.975    270.268  -0.337    0.736    
# StateNC      -29.935    265.410  -0.113    0.910    
# StateND      -86.500    272.482  -0.317    0.751    
# StateNE     -107.353    268.317  -0.400    0.689    
# StateNH     -151.820    269.183  -0.564    0.573    
# StateNJ     -131.810    265.769  -0.496    0.620    
# StateNM     -112.597    268.138  -0.420    0.675    
# StateNV      -35.120    267.553  -0.131    0.896    
# StateNY     -124.351    265.178  -0.469    0.639    
# StateOH      -60.272    265.334  -0.227    0.820    
# StateOK      -45.638    266.283  -0.171    0.864    
# StateOR      -80.866    266.189  -0.304    0.761    
# StatePA      -67.987    265.258  -0.256    0.798    
# StatePR     -130.517    267.297  -0.488    0.625    
# StateRI     -114.245    269.257  -0.424    0.671    
# StateSC      -60.842    265.988  -0.229    0.819    
# StateSD      -69.105    271.684  -0.254    0.799    
# StateTN       -7.245    265.613  -0.027    0.978    
# StateTX      -91.689    265.116  -0.346    0.729    
# StateUT     -136.181    267.473  -0.509    0.611    
# StateVA      -90.700    265.697  -0.341    0.733    
# StateVI     -106.388    374.508  -0.284    0.776    
# StateVT     -101.168    272.266  -0.372    0.710    
# StateWA      -97.212    265.638  -0.366    0.714    
# StateWI      -72.304    265.850  -0.272    0.786    
# StateWV      -64.480    267.184  -0.241    0.809    
# StateWY      -35.288    276.587  -0.128    0.898    
# StateZZ     -245.112    458.670  -0.534    0.593    
# ---
# Signif. codes:  
# 0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Residual standard error: 374.5 on 12743 degrees of freedom
# Multiple R-squared:  0.01726,	Adjusted R-squared:  0.01294 
# F-statistic: 3.997 on 56 and 12743 DF,  p-value: < 2.2e-16

# Plot Results

plot(prescriber_opioids$Gender, prescriber_opioids$summary, xlab="Sex", ylab="Opioid Prescriptions", main="Sex vs. Opioid Prescriptions")

abline(opioid_prescriptions_gender_state_lm)

# Looks like 2 outliers in male dataset - could be driving the effect? Identify 2 outliers, remove, and re-run multivariate linear regression

# Identify max value in summary column

which.max(prescriber_opioids$summary)

prescriber_opioids[7354,]

#Prescriber is male, based in Florda, and healthcare professional specialty is Interventional Pain Management - 15234 prescriptions

# Remove from File

remove_one_max_prescriber_opioids <- prescriber_opioids[-c(7354),]

# check it has been removed

nrow(remove_one_max_prescriber_opioids)


# Identify max of new dataset

which.max(remove_one_max_prescriber_opioids$summary)

remove_one_max_prescriber_opioids[5118,]

#Prescriber is male, based in Louisiana, and healthcare professional specialty is Physical Medicine and Rehabilitation - 14674 prescriptions

remove_two_max_prescriber_opioids <- remove_one_max_prescriber_opioids[-c(5118),]

# Check that the two max values have been removed

max(remove_two_max_prescriber_opioids$summary)


# Re-run linear regression with two max values of men taken out

opioid_prescriptions_gender_state_remove_two_max_male_lm <- lm(formula = summary ~ Gender + State, data=remove_two_max_prescriber_opioids)

summary(opioid_prescriptions_gender_state_remove_two_max_male_lm)

# Plot

plot(remove_two_max_prescriber_opioids$Gender, remove_two_max_prescriber_opioids$summary, xlab="Gender", ylab="Opioid Prescriptions")

abline(lm(summary ~ Gender, remove_two_max_prescriber_opioids))



## (ii) Sex/States/Specialty vs. Opioid Prescriptions

# Multivariate Linear Regression - Gender and State and Specialty

# Collapse Specialties into 10 Categories:

# 01. Family Practice

# Clinic/Center
# Family Medicine
# Family Practice
# General Practice


# 02. Internal Medicine

# Addiction Medicine
# Allergy/Immunology
# Anesthesiology
# Cardiology
# Dermatology
# Endocrinology
# Gastroenterology
# Geriatric Medicine
# Gynecological/Oncology
# Hematology
# Hematology/Oncology
# Hospitalist
# Infectious Disease
# Internal Medicine
# Interventional Radiology
# Nephrology
# Neurology
# Obstetrics/Gynecology
# Ophthalmology
# Otolaryngology
# Preventive Medicine
# Rheumatology
# Sleep Medicine
# Urology


# 03. Nurses

# Certified Clinical Nurse Specialist
# Certified Nurse Midwife
# CRNA
# Licensed Practical Nurse
# Midwife
# Nurse Practitioner
# Registered Nurse


# 04. Physician Assistant

# Physician Assistant


# 05. Emergency Medicine

# Critical Care (Intensivists)
# Emergency Medicine
# General Acute Care Hospital
# Interventional Pain Management
# Personal Emergency Response Attendant


# 06. Dentist/Maxillofacial & Oral Surgery

# Dentist
# Maxillofacial Surgery
# Oral & Maxillofacial Surgery
# Oral Surgery (dentists only)


# 07. Surgery

# Cardiac Surgery
# Colon & Rectal Surgery
# Colorectal Surgery (formerly proctology)
# General Surgery
# Hand Surgery
# Neurological Surgery
# Neurosurgery
# Orthopaedic Surgery
# Orthopedic Surgery
# Plastic and Reconstructive Surgery
# Plastic Surgery
# Surgery
# Surgical Oncology
# Thoracic Surgery
# Thoracic Surgery (Cardiothoracic Vascular Surgery)
# Vascular Surgery


# 08. Physical Therapy/Sports Medicine

# Neuromusculoskeletal Medicine, Sports Medicine
# Osteopathic Manipulative Medicine
# Physical Medicine and Rehabilitation
# Physical Therapist
# Rehabilitation Agency
# Sports Medicine


# 09. Other

# Behavioral Analyst
# Cardiac Electrophysiology
# Chiropractic
# Clinical Pharmacology
# Community Health Worker
# Counselor
# Diagnostic Radiology
# Geriatric Psychiatry
# Health Maintenance Organization
# Homeopath
# Hospice and Palliative Care
# Hospital (Dmercs Only)
# Legal Medicine
# Licensed Clinical Social Worker
# Medical Genetics
# Medical Genetics, Ph.D. Medical Genetics
# Medical Oncology
# Military Health Care Provider
# Multispecialty Clinic/Group Practice
# Naturopath
# Neuropsychiatry
# Nuclear Medicine
# Optometry
# Pain Management
# Pathology
# Pediatric Medicine
# Pharmacist
# Pharmacy Technician
# Podiatry
# Preferred Provider Organization
# Psychiatry
# Psychiatry & Neurology
# Psychologist
# Psychologist (billing independently)
# Pulmonary Disease
# Radiation Oncology
# Slide Preparation Facility
# Specialist
# Specialist/Technologist
# Student in an Organized Health Care Education/Training Program
# Unknown Physician Specialty Code
# Unknown Supplier/Provider

# Recode Specialties into 10 categories

prescriber_opioids_specialty_recoding <- prescriber_opioids$recode <- recode(prescriber_opioids$Specialty, "Clinic/Center" = "Family Practice", "Family Medicine" = "Family Practice", "General Practice" = "Family Practice", "Addiction Medicine" = "Internal Medicine", "Allergy/Immunology" = "Internal Medicine", "Anesthesiology" = "Internal Medicine", "Cardiology" = "Internal Medicine", "Dermatology" = "Internal Medicine", "Dermatology" = "Internal Medicine", "Endocrinology" = "Internal Medicine", "Gastroenterology" = "Internal Medicine", "Geriatric Medicine" = "Internal Medicine", "Gynecological/Oncology" = "Internal Medicine", "Hematology" = "Internal Medicine", "Hematology/Oncology" = "Internal Medicine", "Hospitalist" = "Internal Medicine", "Infectious Disease" = "Internal Medicine", "Interventional Radiology" = "Internal Medicine", "Nephrology" = "Internal Medicine", "Neurology" = "Internal Medicine", "Obstetrics/Gynecology" = "Internal Medicine", "Ophthalmology" = "Internal Medicine", "Otolaryngology" = "Internal Medicine", "Preventive Medicine" = "Internal Medicine", "Rheumatology" = "Internal Medicine", "Sleep Medicine" = "Internal Medicine", "Urology" = "Internal Medicine", "Certified Clinical Nurse Specialist" = "Nurse", "Certified Nurse Midwife" = "Nurse", "CRNA" = "Nurse", "Licensed Practical Nurse" = "Nurse", "Midwife" = "Nurse", "Nurse Practitioner" = "Nurse", "Registered Nurse" = "Nurse", "Critical Care (Intensivists)" = "Emergency Medicine", "General Acute Care Hospital" = "Emergency Medicine", "Interventional Pain Management" = "Emergency Medicine", "Personal Emergency Response Attendant" = "Emergency Medicine", "Maxillofacial Surgery" = "Dentist", "Oral & Maxillofacial Surgery" = "Dentist", "Oral Surgery (dentists only)" = "Dentist", "Cardiac Surgery" = "Surgery", "Colon & Rectal Surgery" = "Surgery", "Colorectal Surgery (formerly proctology)" = "Surgery", "General Surgery" = "Surgery", "Hand Surgery" = "Surgery", "Neurological Surgery" = "Surgery", "Neurosurgery" = "Surgery", "Orthopaedic Surgery" = "Surgery", "Orthopedic Surgery" = "Surgery", "Plastic and Reconstructive Surgery" = "Surgery", "Plastic Surgery" = "Surgery", "Surgical Oncology" = "Surgery", "Thoracic Surgery" = "Surgery", "Thoracic Surgery (Cardiothoracic Vascular Surgery)" = "Surgery", "Vascular Surgery" = "Surgery", "Neuromusculoskeletal Medicine, Sports Medicine" = "Physical Therapist", "Osteopathic Manipulative Medicine" = "Physical Therapist", "Physical Medicine and Rehabilitation" = "Physical Therapist", "Rehabilitation Agency" = "Physical Therapist", "Sports Medicine" = "Physical Therapist", "Clinical Pharmacology" = "Other", "Pharmacy Technician" = "Other", "Pharmacist" = "Other", "Behavioral Analyst" = "Other", "Cardiac Electrophysiology" = "Other", "Chiropractic" = "Other", "Community Health Worker" = "Other", "Counselor" = "Other", "Diagnostic Radiology" = "Other", "Geriatric Psychiatry" = "Other", "Health Maintenance Organization" = "Other", "Homeopath" = "Other", "Hospice and Palliative Care" = "Other", "Hospital (Dmercs Only)" = "Other", "Legal Medicine" = "Other", "Licensed Clinical Social Worker" = "Other", "Medical Genetics" = "Other", "Medical Oncology" = "Other", "Military Health Care Provider" = "Other", "Multispecialty Clinic/Group Practice" = "Other", "Naturopath" = "Other", "Neuropsychiatry" = "Other", "Nuclear Medicine" = "Other", "Optometry" = "Other", "Pain Management" = "Other", "Pathology" = "Other", "Pediatric Medicine" = "Other", "Podiatry" = "Other", "Preferred Provider Organization" = "Other", "Psychiatry" = "Other", "Psychiatry & Neurology" = "Other", "Psychologist" = "Other", "Psychologist (billing independently)" = "Other", "Pulmonary Disease" = "Other", "Radiation Oncology" = "Other", "Slide Preparation Facility" = "Other", "Specialist" = "Other", "Specialist/Technologist" = "Other", "Student in an Organized Health Care Education/Training Program" = "Other", "Unknown Physician Specialty Code" = "Other", "Unknown Supplier/Provider" = "Other", "Medical Genetics, Ph.D. Medical Genetics" = "Other")

# Plot # of healthcare professionals in each of 10 specialty categories

# Count frequency occurrence of state and turn into Data Frame

prescriber_state_specialty_recode <- prescriber_opioids$recode

table_prescriber_state_specialty_recode <- table(prescriber_state_specialty_recode)

# Check if Data Frame 

is.data.frame(table_prescriber_state_specialty_recode)

# Create as Data Frame

df_prescriber_state_specialty_recode <- data.frame(table_prescriber_state_specialty_recode)

# Plot

plot_df_prescriber_state_specialty_recode <- ggplot(data = df_prescriber_state_specialty_recode, mapping= aes(x = reorder(prescriber_state_specialty_recode, -Freq), Freq)) + geom_bar(stat = "identity")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name = "# of opioid prescribers", limits=c(0,4000)) + scale_x_discrete(name="Specialty")

plot_df_prescriber_state_specialty_recode

# Linear Regression

opioid_prescriptions_gender_state_specialty_lm <- lm(formula = summary ~ Gender + State + recode, data=prescriber_opioids)

summary(opioid_prescriptions_gender_state_specialty_lm)

# Plot

plot(prescriber_opioids$recode, prescriber_opioids$summary, xlab="Specialty", ylab="Opioid Prescriptions", las=1.95, main="Specialty vs. Opioid Prescriptions", font=1, cex.axis=0.53)

abline(lm(summary ~ recode, prescriber_opioids))

# Use ggplot to plot categorized healthcare specialty against # of opioid prescriptions

opioid_prescriptions_specialty_categorized <- ggplot(data = prescriber_opioids, aes(recode, summary)) +geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_continuous(name ="# of opioid prescriptions", limits=c(0, 1000000)) + scale_x_discrete(name = "Specialty Categorized")

opioid_prescriptions_specialty_categorized


## (iii) Opioid Prescriptions vs. Opioid-related Overdose Death Rates

# I now have information about opioid prescriptions and the prescribers prescribing those opioids

# I want to relate opioids prescriptions/prescriber info to overdose levels

# Overdoses include information on State Name, State Population, Opioid-related Overdose Deaths, State Abbreviation

# Suggesting to perform a linear regression - I want to predict opioid-related overdose deaths from opioid prescription levels per state

# I will use the lm function

# Sum up aross 11 opioids per prescriber

colnms=c("ACETAMINOPHEN.CODEINE", "FENTANYL", "HYDROCODONE.ACETAMINOPHEN", "HYDROMORPHONE.HCL", "METHADONE.HCL", "MORPHINE.SULFATE", "MORPHINE.SULFATE.ER", "OXYCODONE.ACETAMINOPHEN", "OXYCODONE.HCL", "OXYCONTIN", "TRAMADOL.HCL")

prescriber_opioids_sum <- prescriber_opioids$summary <- rowSums(prescriber_opioids[,colnms])

# Extract out "State" and "summary" columns

prescriber_state_summary <- subset(prescriber_opioids, select = c("State", "summary"))

# Sum per State

prescriber_state_overall_sum <- aggregate(prescriber_state_summary$summary, by=list(prescriber_state_summary$State), FUN=sum)

# Delete rows that don't match up with States in Overdoses file - from visual inspection there are 6 - AE, DC, GU, PR, VI, ZZ

final_prescriber_state_opioid_sum <- prescriber_state_overall_sum[-c(1,9,13,42,50,56), ]

# States in Presciber File are in Alphabetical Order but States in Overdose File are not - need to order States

overdoses_states_ordered <- overdoses[order(overdoses$Abbrev),]

#Need to take out comma from Deaths column in overdoses_states_ordered

overdose_deaths <- overdoses_states_ordered$Deaths

overdose_deaths_no_comma <- gsub(",", "", overdose_deaths)

# Check if file is numeric

is.numeric(overdose_deaths_no_comma)

overdose_deaths_numeric <- as.numeric(overdose_deaths_no_comma)

# Create data frame

states_ordered_prescription_overdose <- data.frame(final_prescriber_state_opioid_sum$x, overdose_deaths_numeric)

#Run linear regresson (Deaths is DV, Opioids Prescriptions per State is IV)

prescriptions_overdoses_lm <- lm(formula = overdose_deaths_numeric ~ final_prescriber_state_opioid_sum.x, data=states_ordered_prescription_overdose)

summary(prescriptions_overdoses_lm)

## Results ##

# Call:
# lm(formula = overdose_deaths_numeric ~ final_prescriber_state_opioid_sum.x, 
#     data = states_ordered_prescription_overdose)

# Residuals:
#     Min      1Q  Median      3Q     Max 
# -602.13 -152.10  -25.87  174.82  816.64 
# 
# Coefficients:
#                                      Estimate Std. Error
# (Intercept)                         64.033622  65.909497
# final_prescriber_state_opioid_sum.x  0.020553   0.001122
#                                     t value Pr(>|t|)    
# (Intercept)                           0.972    0.336    
# final_prescriber_state_opioid_sum.x  18.317   <2e-16 ***
# ---
# Signif. codes:  
# 0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Residual standard error: 321 on 48 degrees of freedom
# Multiple R-squared:  0.8748,	Adjusted R-squared:  0.8722 
# F-statistic: 335.5 on 1 and 48 DF,  p-value: < 2.2e-16

# Plot results of linear regression

plot(states_ordered_prescription_overdose$final_prescriber_state_opioid_sum.x, states_ordered_prescription_overdose$overdose_deaths_numeric, xlab="Opioid prescriptions per state", ylab="Opioid-related overdose deaths", main="Opioid Prescriptions vs. Opioid-related Overdose Deaths")

abline(prescriptions_overdoses_lm)

abline(prescriptions_overdoses_lm, col="red")

```


```{r}
